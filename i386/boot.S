/* Copyright (C) 2018 Jake Shilling <shilling.jake@gmail.com>
 * 
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>. */

/* file: i386/boot.S
 *
 *   This is where we define the entry point for our kernel. Execution
 * starts with the _start function in protected mode. From there we set
 * up paging and jump to the higher half */

#define ASM_FILE 1
#include <ldscript.h>
#include <multiboot2.h>

/* GRUB2 wants a multiboot2 header at the beginning of the kernel image. The
   linker script will put this in the right place */
.section .multiboot_header
.align 8
multiboot_header_start:
	.long	MULTIBOOT2_HEADER_MAGIC
	.long	MULTIBOOT_ARCHITECTURE_I386
	.long	multiboot_header_end - multiboot_header_start
	.long	-(MULTIBOOT2_HEADER_MAGIC + MULTIBOOT_ARCHITECTURE_I386 + (multiboot_header_end - multiboot_header_start))
  
	.short	MULTIBOOT_HEADER_TAG_END
	.short	0
	.long	8
multiboot_header_end:

/* Multiboot does not necessarily leave us with a valide GDT. This is a
   temporary one before we can figure out how many TSS entries we will
   need */
.section .boot_gdt
.align 16
boot_gdt:
	/* null descriptor */
	.quad 0
	/* code */
	.word 0xFFFF
	.word 0x0
	.byte 0x0
	.byte 0x9a
	.byte 0xcf
	.byte 0x0
	/* data segment */
	.word 0xFFFF
	.word 0x0
	.byte 0x0
	.byte 0x92
	.byte 0xcf
	.byte 0x0
boot_gdt_end:

boot_gdt_descr:
	.word boot_gdt - boot_gdt_end
	.long boot_gdt - KERNEL_OFFSET

/* We will start of my mapping a single 1GiB page. This should be more
   than enough for everything we need before we can use the Multiboot
   information to map out available memory. */
.section .boot_paging
.align 0x1000
.type boot_pt, @object
boot_pd:
	.long (0x00000000 | 0x83)
	.long (0x00400000 | 0x83)
	.long (0x00800000 | 0x83)
	.long (0x00c00000 | 0x83)
	.long (0x01000000 | 0x83)
	.long (0x01400000 | 0x83)
	.long (0x01800000 | 0x83)
	.long (0x01c00000 | 0x83)
	.long (0x02000000 | 0x83)
	.long (0x02400000 | 0x83)
	.long (0x02800000 | 0x83)
	.long (0x02c00000 | 0x83)
	.long (0x03000000 | 0x83)
	.long (0x03400000 | 0x83)
	.long (0x03800000 | 0x83)
	.long (0x03c00000 | 0x83)
	.long (0x04000000 | 0x83)
	.long (0x04400000 | 0x83)
	.long (0x04800000 | 0x83)
	.long (0x04c00000 | 0x83)
	.long (0x04000000 | 0x83)
	.long (0x04400000 | 0x83)
	.long (0x04800000 | 0x83)
	.long (0x04c00000 | 0x83)
	.long (0x05000000 | 0x83)
	.long (0x05400000 | 0x83)
	.long (0x05800000 | 0x83)
	.long (0x05c00000 | 0x83)
	.long (0x06000000 | 0x83)
	.long (0x06400000 | 0x83)
	.long (0x06800000 | 0x83)
	.long (0x06c00000 | 0x83)
	.long (0x07000000 | 0x83)
	.long (0x07400000 | 0x83)
	.long (0x07800000 | 0x83)
	.long (0x07c00000 | 0x83)
	.long (0x08000000 | 0x83)
	.long (0x08400000 | 0x83)
	.long (0x08800000 | 0x83)
	.long (0x08c00000 | 0x83)
	.long (0x09000000 | 0x83)
	.long (0x09400000 | 0x83)
	.long (0x09800000 | 0x83)
	.long (0x09c00000 | 0x83)
	.long (0x0a000000 | 0x83)
	.long (0x0a400000 | 0x83)
	.long (0x0a800000 | 0x83)
	.long (0x0ac00000 | 0x83)
	.long (0x0b000000 | 0x83)
	.long (0x0b400000 | 0x83)
	.long (0x0b800000 | 0x83)
	.long (0x0bc00000 | 0x83)
	.long (0x0c000000 | 0x83)
	.long (0x0c400000 | 0x83)
	.long (0x0c800000 | 0x83)
	.long (0x0cc00000 | 0x83)
	.long (0x0e000000 | 0x83)
	.long (0x0e400000 | 0x83)
	.long (0x0e800000 | 0x83)
	.long (0x0ec00000 | 0x83)
	.long (0x0f000000 | 0x83)
	.long (0x0f400000 | 0x83)
	.long (0x0f800000 | 0x83)
	.long (0x0fc00000 | 0x83)
	.long (0x20000000 | 0x83)
	.long (0x20400000 | 0x83)
	.long (0x20800000 | 0x83)
	.long (0x20c00000 | 0x83)
	.long (0x21000000 | 0x83)
	.long (0x21400000 | 0x83)
	.long (0x21800000 | 0x83)
	.long (0x21c00000 | 0x83)
	.long (0x22000000 | 0x83)
	.long (0x22400000 | 0x83)
	.long (0x22800000 | 0x83)
	.long (0x22c00000 | 0x83)
	.long (0x23000000 | 0x83)
	.long (0x23400000 | 0x83)
	.long (0x23800000 | 0x83)
	.long (0x23c00000 | 0x83)
	.long (0x24000000 | 0x83)
	.long (0x24400000 | 0x83)
	.long (0x24800000 | 0x83)
	.long (0x24c00000 | 0x83)
	.long (0x24000000 | 0x83)
	.long (0x24400000 | 0x83)
	.long (0x24800000 | 0x83)
	.long (0x24c00000 | 0x83)
	.long (0x25000000 | 0x83)
	.long (0x25400000 | 0x83)
	.long (0x25800000 | 0x83)
	.long (0x25c00000 | 0x83)
	.long (0x26000000 | 0x83)
	.long (0x26400000 | 0x83)
	.long (0x26800000 | 0x83)
	.long (0x26c00000 | 0x83)
	.long (0x27000000 | 0x83)
	.long (0x27400000 | 0x83)
	.long (0x27800000 | 0x83)
	.long (0x27c00000 | 0x83)
	.long (0x28000000 | 0x83)
	.long (0x28400000 | 0x83)
	.long (0x28800000 | 0x83)
	.long (0x28c00000 | 0x83)
	.long (0x29000000 | 0x83)
	.long (0x29400000 | 0x83)
	.long (0x29800000 | 0x83)
	.long (0x29c00000 | 0x83)
	.long (0x2a000000 | 0x83)
	.long (0x2a400000 | 0x83)
	.long (0x2a800000 | 0x83)
	.long (0x2ac00000 | 0x83)
	.long (0x2b000000 | 0x83)
	.long (0x2b400000 | 0x83)
	.long (0x2b800000 | 0x83)
	.long (0x2bc00000 | 0x83)
	.long (0x2c000000 | 0x83)
	.long (0x2c400000 | 0x83)
	.long (0x2c800000 | 0x83)
	.long (0x2cc00000 | 0x83)
	.long (0x2e000000 | 0x83)
	.long (0x2e400000 | 0x83)
	.long (0x2e800000 | 0x83)
	.long (0x2ec00000 | 0x83)
	.long (0x2f000000 | 0x83)
	.long (0x2f400000 | 0x83)
	.long (0x2f800000 | 0x83)
	.long (0x2fc00000 | 0x83)
	.long (0x30000000 | 0x83)
	.long (0x30400000 | 0x83)
	.long (0x30800000 | 0x83)
	.long (0x30c00000 | 0x83)
	.long (0x31000000 | 0x83)
	.long (0x31400000 | 0x83)
	.long (0x31800000 | 0x83)
	.long (0x31c00000 | 0x83)
	.long (0x32000000 | 0x83)
	.long (0x32400000 | 0x83)
	.long (0x32800000 | 0x83)
	.long (0x32c00000 | 0x83)
	.long (0x33000000 | 0x83)
	.long (0x33400000 | 0x83)
	.long (0x33800000 | 0x83)
	.long (0x33c00000 | 0x83)
	.long (0x34000000 | 0x83)
	.long (0x34400000 | 0x83)
	.long (0x34800000 | 0x83)
	.long (0x34c00000 | 0x83)
	.long (0x34000000 | 0x83)
	.long (0x34400000 | 0x83)
	.long (0x34800000 | 0x83)
	.long (0x34c00000 | 0x83)
	.long (0x35000000 | 0x83)
	.long (0x35400000 | 0x83)
	.long (0x35800000 | 0x83)
	.long (0x35c00000 | 0x83)
	.long (0x36000000 | 0x83)
	.long (0x36400000 | 0x83)
	.long (0x36800000 | 0x83)
	.long (0x36c00000 | 0x83)
	.long (0x37000000 | 0x83)
	.long (0x37400000 | 0x83)
	.long (0x37800000 | 0x83)
	.long (0x37c00000 | 0x83)
	.long (0x38000000 | 0x83)
	.long (0x38400000 | 0x83)
	.long (0x38800000 | 0x83)
	.long (0x38c00000 | 0x83)
	.long (0x39000000 | 0x83)
	.long (0x39400000 | 0x83)
	.long (0x39800000 | 0x83)
	.long (0x39c00000 | 0x83)
	.long (0x3a000000 | 0x83)
	.long (0x3a400000 | 0x83)
	.long (0x3a800000 | 0x83)
	.long (0x3ac00000 | 0x83)
	.long (0x3b000000 | 0x83)
	.long (0x3b400000 | 0x83)
	.long (0x3b800000 | 0x83)
	.long (0x3bc00000 | 0x83)
	.long (0x3c000000 | 0x83)
	.long (0x3c400000 | 0x83)
	.long (0x3c800000 | 0x83)
	.long (0x3cc00000 | 0x83)
	.long (0x3e000000 | 0x83)
	.long (0x3e400000 | 0x83)
	.long (0x3e800000 | 0x83)
	.long (0x3ec00000 | 0x83)
	.long (0x3f000000 | 0x83)
	.long (0x3f400000 | 0x83)
	.long (0x3f800000 | 0x83)
	.long (0x3fc00000 | 0x83)
	.long (0x40000000 | 0x83)
	.long (0x40400000 | 0x83)
	.long (0x40800000 | 0x83)
	.long (0x40c00000 | 0x83)
	.long (0x41000000 | 0x83)
	.long (0x41400000 | 0x83)
	.long (0x41800000 | 0x83)
	.long (0x41c00000 | 0x83)
	.long (0x42000000 | 0x83)
	.long (0x42400000 | 0x83)
	.long (0x42800000 | 0x83)
	.long (0x42c00000 | 0x83)
	.long (0x43000000 | 0x83)
	.long (0x43400000 | 0x83)
	.long (0x43800000 | 0x83)
	.long (0x43c00000 | 0x83)
	.long (0x44000000 | 0x83)
	.long (0x44400000 | 0x83)
	.long (0x44800000 | 0x83)
	.long (0x44c00000 | 0x83)
	.long (0x44000000 | 0x83)
	.long (0x44400000 | 0x83)
	.long (0x44800000 | 0x83)
	.long (0x44c00000 | 0x83)
	.long (0x45000000 | 0x83)
	.long (0x45400000 | 0x83)
	.long (0x45800000 | 0x83)
	.long (0x45c00000 | 0x83)
	.long (0x46000000 | 0x83)
	.long (0x46400000 | 0x83)
	.long (0x46800000 | 0x83)
	.long (0x46c00000 | 0x83)
	.long (0x47000000 | 0x83)
	.long (0x47400000 | 0x83)
	.long (0x47800000 | 0x83)
	.long (0x47c00000 | 0x83)
	.long (0x48000000 | 0x83)
	.long (0x48400000 | 0x83)
	.long (0x48800000 | 0x83)
	.long (0x48c00000 | 0x83)
	.long (0x49000000 | 0x83)
	.long (0x49400000 | 0x83)
	.long (0x49800000 | 0x83)
	.long (0x49c00000 | 0x83)
	.long (0x4a000000 | 0x83)
	.long (0x4a400000 | 0x83)
	.long (0x4a800000 | 0x83)
	.long (0x4ac00000 | 0x83)
	.long (0x4b000000 | 0x83)
	.long (0x4b400000 | 0x83)
	.long (0x4b800000 | 0x83)
	.long (0x4bc00000 | 0x83)
	.long (0x4c000000 | 0x83)
	.long (0x4c400000 | 0x83)
	.long (0x4c800000 | 0x83)
	.long (0x4cc00000 | 0x83)
	.long (0x4e000000 | 0x83)
	.long (0x4e400000 | 0x83)
	.long (0x4e800000 | 0x83)
	.long (0x4ec00000 | 0x83)
	.long (0x4f000000 | 0x83)
	.long (0x4f400000 | 0x83)
	.long (0x4f800000 | 0x83)
	.long (0x4fc00000 | 0x83)

	.skip 512 * 4, 0

	.long (0x00000000 | 0x83)
	.long (0x00400000 | 0x83)
	.long (0x00800000 | 0x83)
	.long (0x00c00000 | 0x83)
	.long (0x01000000 | 0x83)
	.long (0x01400000 | 0x83)
	.long (0x01800000 | 0x83)
	.long (0x01c00000 | 0x83)
	.long (0x02000000 | 0x83)
	.long (0x02400000 | 0x83)
	.long (0x02800000 | 0x83)
	.long (0x02c00000 | 0x83)
	.long (0x03000000 | 0x83)
	.long (0x03400000 | 0x83)
	.long (0x03800000 | 0x83)
	.long (0x03c00000 | 0x83)
	.long (0x04000000 | 0x83)
	.long (0x04400000 | 0x83)
	.long (0x04800000 | 0x83)
	.long (0x04c00000 | 0x83)
	.long (0x04000000 | 0x83)
	.long (0x04400000 | 0x83)
	.long (0x04800000 | 0x83)
	.long (0x04c00000 | 0x83)
	.long (0x05000000 | 0x83)
	.long (0x05400000 | 0x83)
	.long (0x05800000 | 0x83)
	.long (0x05c00000 | 0x83)
	.long (0x06000000 | 0x83)
	.long (0x06400000 | 0x83)
	.long (0x06800000 | 0x83)
	.long (0x06c00000 | 0x83)
	.long (0x07000000 | 0x83)
	.long (0x07400000 | 0x83)
	.long (0x07800000 | 0x83)
	.long (0x07c00000 | 0x83)
	.long (0x08000000 | 0x83)
	.long (0x08400000 | 0x83)
	.long (0x08800000 | 0x83)
	.long (0x08c00000 | 0x83)
	.long (0x09000000 | 0x83)
	.long (0x09400000 | 0x83)
	.long (0x09800000 | 0x83)
	.long (0x09c00000 | 0x83)
	.long (0x0a000000 | 0x83)
	.long (0x0a400000 | 0x83)
	.long (0x0a800000 | 0x83)
	.long (0x0ac00000 | 0x83)
	.long (0x0b000000 | 0x83)
	.long (0x0b400000 | 0x83)
	.long (0x0b800000 | 0x83)
	.long (0x0bc00000 | 0x83)
	.long (0x0c000000 | 0x83)
	.long (0x0c400000 | 0x83)
	.long (0x0c800000 | 0x83)
	.long (0x0cc00000 | 0x83)
	.long (0x0e000000 | 0x83)
	.long (0x0e400000 | 0x83)
	.long (0x0e800000 | 0x83)
	.long (0x0ec00000 | 0x83)
	.long (0x0f000000 | 0x83)
	.long (0x0f400000 | 0x83)
	.long (0x0f800000 | 0x83)
	.long (0x0fc00000 | 0x83)
	.long (0x20000000 | 0x83)
	.long (0x20400000 | 0x83)
	.long (0x20800000 | 0x83)
	.long (0x20c00000 | 0x83)
	.long (0x21000000 | 0x83)
	.long (0x21400000 | 0x83)
	.long (0x21800000 | 0x83)
	.long (0x21c00000 | 0x83)
	.long (0x22000000 | 0x83)
	.long (0x22400000 | 0x83)
	.long (0x22800000 | 0x83)
	.long (0x22c00000 | 0x83)
	.long (0x23000000 | 0x83)
	.long (0x23400000 | 0x83)
	.long (0x23800000 | 0x83)
	.long (0x23c00000 | 0x83)
	.long (0x24000000 | 0x83)
	.long (0x24400000 | 0x83)
	.long (0x24800000 | 0x83)
	.long (0x24c00000 | 0x83)
	.long (0x24000000 | 0x83)
	.long (0x24400000 | 0x83)
	.long (0x24800000 | 0x83)
	.long (0x24c00000 | 0x83)
	.long (0x25000000 | 0x83)
	.long (0x25400000 | 0x83)
	.long (0x25800000 | 0x83)
	.long (0x25c00000 | 0x83)
	.long (0x26000000 | 0x83)
	.long (0x26400000 | 0x83)
	.long (0x26800000 | 0x83)
	.long (0x26c00000 | 0x83)
	.long (0x27000000 | 0x83)
	.long (0x27400000 | 0x83)
	.long (0x27800000 | 0x83)
	.long (0x27c00000 | 0x83)
	.long (0x28000000 | 0x83)
	.long (0x28400000 | 0x83)
	.long (0x28800000 | 0x83)
	.long (0x28c00000 | 0x83)
	.long (0x29000000 | 0x83)
	.long (0x29400000 | 0x83)
	.long (0x29800000 | 0x83)
	.long (0x29c00000 | 0x83)
	.long (0x2a000000 | 0x83)
	.long (0x2a400000 | 0x83)
	.long (0x2a800000 | 0x83)
	.long (0x2ac00000 | 0x83)
	.long (0x2b000000 | 0x83)
	.long (0x2b400000 | 0x83)
	.long (0x2b800000 | 0x83)
	.long (0x2bc00000 | 0x83)
	.long (0x2c000000 | 0x83)
	.long (0x2c400000 | 0x83)
	.long (0x2c800000 | 0x83)
	.long (0x2cc00000 | 0x83)
	.long (0x2e000000 | 0x83)
	.long (0x2e400000 | 0x83)
	.long (0x2e800000 | 0x83)
	.long (0x2ec00000 | 0x83)
	.long (0x2f000000 | 0x83)
	.long (0x2f400000 | 0x83)
	.long (0x2f800000 | 0x83)
	.long (0x2fc00000 | 0x83)
	.long (0x30000000 | 0x83)
	.long (0x30400000 | 0x83)
	.long (0x30800000 | 0x83)
	.long (0x30c00000 | 0x83)
	.long (0x31000000 | 0x83)
	.long (0x31400000 | 0x83)
	.long (0x31800000 | 0x83)
	.long (0x31c00000 | 0x83)
	.long (0x32000000 | 0x83)
	.long (0x32400000 | 0x83)
	.long (0x32800000 | 0x83)
	.long (0x32c00000 | 0x83)
	.long (0x33000000 | 0x83)
	.long (0x33400000 | 0x83)
	.long (0x33800000 | 0x83)
	.long (0x33c00000 | 0x83)
	.long (0x34000000 | 0x83)
	.long (0x34400000 | 0x83)
	.long (0x34800000 | 0x83)
	.long (0x34c00000 | 0x83)
	.long (0x34000000 | 0x83)
	.long (0x34400000 | 0x83)
	.long (0x34800000 | 0x83)
	.long (0x34c00000 | 0x83)
	.long (0x35000000 | 0x83)
	.long (0x35400000 | 0x83)
	.long (0x35800000 | 0x83)
	.long (0x35c00000 | 0x83)
	.long (0x36000000 | 0x83)
	.long (0x36400000 | 0x83)
	.long (0x36800000 | 0x83)
	.long (0x36c00000 | 0x83)
	.long (0x37000000 | 0x83)
	.long (0x37400000 | 0x83)
	.long (0x37800000 | 0x83)
	.long (0x37c00000 | 0x83)
	.long (0x38000000 | 0x83)
	.long (0x38400000 | 0x83)
	.long (0x38800000 | 0x83)
	.long (0x38c00000 | 0x83)
	.long (0x39000000 | 0x83)
	.long (0x39400000 | 0x83)
	.long (0x39800000 | 0x83)
	.long (0x39c00000 | 0x83)
	.long (0x3a000000 | 0x83)
	.long (0x3a400000 | 0x83)
	.long (0x3a800000 | 0x83)
	.long (0x3ac00000 | 0x83)
	.long (0x3b000000 | 0x83)
	.long (0x3b400000 | 0x83)
	.long (0x3b800000 | 0x83)
	.long (0x3bc00000 | 0x83)
	.long (0x3c000000 | 0x83)
	.long (0x3c400000 | 0x83)
	.long (0x3c800000 | 0x83)
	.long (0x3cc00000 | 0x83)
	.long (0x3e000000 | 0x83)
	.long (0x3e400000 | 0x83)
	.long (0x3e800000 | 0x83)
	.long (0x3ec00000 | 0x83)
	.long (0x3f000000 | 0x83)
	.long (0x3f400000 | 0x83)
	.long (0x3f800000 | 0x83)
	.long (0x3fc00000 | 0x83)
	.long (0x40000000 | 0x83)
	.long (0x40400000 | 0x83)
	.long (0x40800000 | 0x83)
	.long (0x40c00000 | 0x83)
	.long (0x41000000 | 0x83)
	.long (0x41400000 | 0x83)
	.long (0x41800000 | 0x83)
	.long (0x41c00000 | 0x83)
	.long (0x42000000 | 0x83)
	.long (0x42400000 | 0x83)
	.long (0x42800000 | 0x83)
	.long (0x42c00000 | 0x83)
	.long (0x43000000 | 0x83)
	.long (0x43400000 | 0x83)
	.long (0x43800000 | 0x83)
	.long (0x43c00000 | 0x83)
	.long (0x44000000 | 0x83)
	.long (0x44400000 | 0x83)
	.long (0x44800000 | 0x83)
	.long (0x44c00000 | 0x83)
	.long (0x44000000 | 0x83)
	.long (0x44400000 | 0x83)
	.long (0x44800000 | 0x83)
	.long (0x44c00000 | 0x83)
	.long (0x45000000 | 0x83)
	.long (0x45400000 | 0x83)
	.long (0x45800000 | 0x83)
	.long (0x45c00000 | 0x83)
	.long (0x46000000 | 0x83)
	.long (0x46400000 | 0x83)
	.long (0x46800000 | 0x83)
	.long (0x46c00000 | 0x83)
	.long (0x47000000 | 0x83)
	.long (0x47400000 | 0x83)
	.long (0x47800000 | 0x83)
	.long (0x47c00000 | 0x83)
	.long (0x48000000 | 0x83)
	.long (0x48400000 | 0x83)
	.long (0x48800000 | 0x83)
	.long (0x48c00000 | 0x83)
	.long (0x49000000 | 0x83)
	.long (0x49400000 | 0x83)
	.long (0x49800000 | 0x83)
	.long (0x49c00000 | 0x83)
	.long (0x4a000000 | 0x83)
	.long (0x4a400000 | 0x83)
	.long (0x4a800000 | 0x83)
	.long (0x4ac00000 | 0x83)
	.long (0x4b000000 | 0x83)
	.long (0x4b400000 | 0x83)
	.long (0x4b800000 | 0x83)
	.long (0x4bc00000 | 0x83)
	.long (0x4c000000 | 0x83)
	.long (0x4c400000 | 0x83)
	.long (0x4c800000 | 0x83)
	.long (0x4cc00000 | 0x83)
	.long (0x4e000000 | 0x83)
	.long (0x4e400000 | 0x83)
	.long (0x4e800000 | 0x83)
	.long (0x4ec00000 | 0x83)
	.long (0x4f000000 | 0x83)
	.long (0x4f400000 | 0x83)
	.long (0x4f800000 | 0x83)
	.long (0x4fc00000 | 0x83)

.section .bss
.align 16
boot_stack_bottom:
	.skip 0x1000
boot_stack_top:

.section .rodata
err_no_multiboot_msg:	.asciz "This was not booted from a Multiboot2 bootloader."
err_no_cpuid_msg:	.asciz "Cannot detect system features."
err_no_pse_msg:		.asciz "Cannot enable 1MiB pages on this system."
 
/*
The linker script specifies _start as the entry point to the kernel and the
bootloader will jump to this position once the kernel has been loaded. It
doesn't make sense to return from this function as the bootloader is gone.
*/
.section .text
.global _start
.type _start, @function
_start:
	/* Check Multiboot2 magic number */
	cmpl	$(MULTIBOOT2_BOOTLOADER_MAGIC),%eax
	jne	err_no_multiboot

	/* Multiboot2 does not gaurentee a valid gdt, so we need to load our own */
	lgdt	boot_gdt_descr - KERNEL_OFFSET
	ljmp	$8,$(cs_set - KERNEL_OFFSET)
cs_set:
	movw	$0,%ax
	movw	%ax,%ds
	movw	%ax,%es
	movw	%ax,%fs
	movw	%ax,%gs
	movw	$16,%ax
	movw	%ax,%ds
	movw	%ax,%es
	movw	%ax,%ss

	/* Set up a stack */
	movl	$(boot_stack_top - KERNEL_OFFSET),%esp

	/* Check for the existance of CPUID by seeing if we can flip bit 21 in EFLAGS */
	/* First get the EFLAGS in eax, save a copy in ecx, then try to change bit 21 */
	pushf
	pop	%eax
	movl	%eax,%ecx
	xor	$(1 << 21),%eax
	push	%eax
	popf
	/* Get the result back from EFLAGS in eax, then push the original state back
	   from ecx */
	pushf
	pop	%eax
	push	%ecx
	popf
	/* If ecx == eax then CPUID is not supported */
	xor	%ecx,%eax
	jz	err_no_cpuid

	/* Now use CPUID to check whether PSE is supported. EAX=1. */
	movl	$0x1,%eax
	cpuid
	test	$(1 << 3),%edx
	jz	err_no_pse

	/* Set the address of boot_pd in cr3 */
	movl	$(boot_pd - KERNEL_OFFSET),%edi
	movl	%edi,%cr3

	/* Enable PSE */
	movl	%cr4,%eax
	or	$(1 << 4),%eax
	movl	%eax,%cr4

	/* Enable paging */
	movl	%cr0,%eax
	or	$(1 << 31),%eax
	movl	%eax,%cr0

	/* Jump to higher half */
	lea	higher_half,%eax
	jmp	*%eax

higher_half:
	

halt:
	cli
1:	hlt
	jmp 1b

err_no_multiboot:
	mov	$(err_no_multiboot_msg - KERNEL_OFFSET),%eax
	push	%eax
	call	_boot_puts
	add	$4,%esp
	jmp	halt

err_no_cpuid:
	mov	$(err_no_cpuid_msg - KERNEL_OFFSET),%eax
	push	%eax
	call	_boot_puts
	add	$4,%esp
	jmp	halt

err_no_pse:
	mov	$(err_no_pse_msg - KERNEL_OFFSET),%eax
	push	%eax
	call	_boot_puts
	add	$4,%esp
	jmp	halt
 
.size _start, . - _start

/* We will use these functions to write to the screen while still bootstraping. On
   x86 systems, video memory starts at 0xb8000. Each character is 2-bytes, with the first
   byte holding formating information, the second is the ascii code. There are 80 columns
   and 25 rows. (80 * 25) == 2000. sizeof(video memory) == 4000. */

/* Our screen will have a black background (0) and a light-grey foreground (7). The
   formating byte comes out to (7 | (0 << 4)) == 0x07. */

.type _boot_puts, @function
_boot_puts:
	push	%ebp
	movl	%esp,%ebp

	/* First clear the screen, i.e. fill with spaces (ascii = 0x20) */
	/* Use the 4-byte register to write two spaces at a time. Loop over video
	   memory (80 * 25) / 2 times (1000) */
	movl	$0xb8000,%edi
	movl	$0x07200720,%edx
	movl	$1000,%ecx
clear_screen:
	movl	%edx,(%edi)
	add	$4,%edi
	loop	clear_screen

	/* Next get the physical address of the string passed on the stack */
	movl	8(%esp),%esi
	/* Set up for the loop */
	movl	$0xb8000,%edi
	mov	$0x07,%ah
putchar:
	mov	(%esi),%al
	/* Check for null-termination */
	cmp	$0,%al
	je	end
	mov	%ax,(%edi)
	/* Next output-char location */
	add	$2,%edi
	/* Next char in string */
	inc	%esi
	/* Loop */
	jmp	putchar
end:

	pop	%ebp
	ret
.size _boot_puts, . - _boot_puts